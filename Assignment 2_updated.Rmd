---
title: "Assignment 2"
author: "Omar Amin"
date: "2022-10-28"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
  fig_width: 12
fig_height: 24
header-includes:
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r my-chunk, R.options = list(width = 40)}

```


# The geographic distribution and evolutionary diversification of the *phrynocephalus* genus

In this assignment, I am doing point C, which is the geographic distribution and evolutionary diversification. I am using the same genus that I used in the first assignment which is the *Phrynocephalus*. They are a group of 33 species situated exclusively in the Qinghai-Tibetan plateau. These toad-headed species have been a focus of evolutionary studies due to their localization in the plateau, which helps in understanding the relationship between geography and speciation. My question today is to elucidate whether the biological evolutionary distances between the species in this group can be projected on the locations of the species in the plateau. One study that caught my interest (citation) is mentioning a hypothesis about the biogeographic clades of this groups and the location of the tectonic plates. They sequenced a region of the mitochondria genome (from 3’ end of *ND1* to 5’ end of *COI*) and they sequenced the *RAG-1* gene as well. 

My goal here is to obtain the sequences of the mitochondrial region in the study, build the phylogenetic trees of the DNA sequences and then project the phylogenetic tree on the latitudes and longitudes of the *Phrynocephalus* species.


**Part 1: Data discovery and manipulation**

First of all, I obtained the sequences mitochondrial sequences from study (citation), their ids are from KJ195906-195944, so I wrote an sapply function to generate the Ids quickly

```{r message=FALSE, warning=FALSE}
library(phytools)
library(mapdata)
library(phytools)
library(rentrez)
library(magrittr)
library(dplyr)
library(measurements)
library(stringi)
library(ape)
library(RSQLite)
library(Biostrings)
library(muscle)
library(tidyr)
library(DECIPHER)
library(stringr)
library(viridis)
library(readr)

phryo_mitoc_ids <- sapply(195906:195944, function(x) paste0("KJ", 
                                                            as.character(x)) )

head(phryo_mitoc_ids)
length(phryo_mitoc_ids)
```
Now we have 39 Ids, the next step will be to fetch the fasta files of these Ids, save them in a variable and a file at the same time, then convert the sequences into a dnastringset object and convert it into a dataframe. I also extracted the speices names using regular expression from the sequences titles

```{r}
mitoc_fastas <- entrez_fetch(db = "nuccore", id = phryo_mitoc_ids, 
                             rettype = "fasta") %T>% 
  write("mitoc.fasta", sep = "\n")
mitocstringSet <- readDNAStringSet("mitoc.fasta")
mitoc_df <- data.frame(sequence_name = names(mitocstringSet), 
                       mitoc_Sequence = paste(mitocstringSet)) %>%
  mutate(species_name=str_match(sequence_name,
                                                                                                 "(Phrynocephalus.+?)voucher")[,2])

mitoc_df[1,]
```

The summary in the NCBI has the latitudes and longitudes of the sequences, and they are located in the description of the sequences, so I used REGEX and sapply to extract them

```{r}
phryo_mitoc_summ <- entrez_summary(db = "nuccore", id = phryo_mitoc_ids)
mitoc_lat_lon <- as.data.frame(t(sapply(phryo_mitoc_summ, function(x) str_match(x$subname, "([0-9]+) deg ([0-9]*\\.?[0-9]*)' N,? ([0-9]+) deg ([0-9]*\\.?[0-9]*)' E|([0-9]*\\.?[0-9]*) N,? ([0-9]*\\.?[0-9]*) E"))))

mitoc_lat_lon[1:4,]
```
As we see here, because the formatting of the lats and lons were all over the place between different entries, we have the numbers in the degree format and the normal decimal format, so I'll be using a package called measurements to change the degrees to the decimal format and keep the decimal as they are, then combining the columns together to create one singular lat and lon column

```{r message=FALSE, warning=FALSE}
mitoc_geos <- mitoc_lat_lon %>% 
  unite("lat", V2:V3, remove = TRUE, sep = " ") %>% 
  unite("lon", V4:V5, remove = TRUE, sep = " ")
mitoc_geos$lat <- conv_unit(mitoc_geos$lat, from = 'deg_dec_min', 
                            to = 'dec_deg')
mitoc_geos$lon <- conv_unit(mitoc_geos$lon, from = 'deg_dec_min', 
                            to = 'dec_deg')
mitoc_geos_final <- mitoc_geos %>% 
  unite("lat", c(lat, V6), remove = TRUE, na.rm = TRUE) %>%
  unite("lon", c(lon, V7), remove = TRUE, na.rm = TRUE) %>% select(lat, lon)

mitoc_geos_final[1:4, ]

```
Finally, combining the geopositions with the sequences and removing the sequences that we couldn't find the values for as it will not be benefical for our test, we are also adding here the NCBI accession number for later use in the phylogenetic formation

```{r message=FALSE, warning=FALSE}
mitoc_final <- cbind(identifier=paste0(sapply(phryo_mitoc_summ, function(x) x[["caption"]]),":",mitoc_df$species_name),mitoc_df, mitoc_geos_final) %>% filter(lat!="", lon!="")

mitoc_final[1:4, ]
```


**Part 2: Alignment, clustering and tree formation**

I checked these sequences manually, and found no Ns or any other characters other than the normal base pairs so they're  for processing, we will start here with the mitochondira sequences, I should mention that these codes were taken form the classes' scripts. we used here the TN93 model, which assumes distinct rates for both kinds of transition (A <-> G versus C <-> T)

```{r message=FALSE, warning=FALSE, results=FALSE}
mitoc_final$mitoc_Sequence <- DNAStringSet(mitoc_final$mitoc_Sequence)
names(mitoc_final$mitoc_Sequence) <- mitoc_final$identifier
mitoc_final_alignment <-DNAStringSet(muscle(mitoc_final$mitoc_Sequence))
mitoc_bin <- as.DNAbin(mitoc_final_alignment)
distanceMatrix.raw <- dist.dna(mitoc_bin, model = "TN93", as.matrix = TRUE, pairwise.deletion = TRUE)

```


```{r fig.width = 20, fig.height = 15}
nj_mitoc_tn93 <- nj(distanceMatrix.raw)
plot(nj_mitoc_tn93)
```


As this tree is a neighbor-joining tree, we need to convert it to ultrametic trees to be able to produce a geophylogenetic tree

```{r warning=FALSE, message=FALSE,  include=FALSE, fig.width = 20, fig.height = 15}
mitoc_ultra <- force.ultrametric(nj_mitoc_tn93)
```


**Part 3: Geophylogeny analysis**


Now to align these trees to a map using the lats and lons of the dataframes we created earlier on, we will start with the mitochondrial phylogenetic tree, the function "phylo.to.map" takes 2 main objects: a phylogenetic tree and a matrix consisting of the lats and lons (while its rownames cooresponds to the rownames of the tips of the tree). So, I generated a matrix from mitoc_final


```{r}
mitoc_coord <- select(mitoc_final, lat, lon)
mitoc_coord$lat <- as.numeric(mitoc_coord$lat)
mitoc_coord$lon <- as.numeric(mitoc_coord$lon)
mitoc_coord <- as.matrix(mitoc_coord)
rownames(mitoc_coord) <- mitoc_final$identifier

```


I kept having an error while trying to generate a phylogram, I will try to look into it later but I had to change the type from "phylogram" to "direct", which draws the tree on the map itself.


```{r fig.width = 25, fig.height = 15, error=FALSE, out.width = "6in", fig.cap ="The geophylogenetic tree of the \\textit{Phrynocephalus} genus, using the mitochondira sequences alignment"}


mitoc_obj <- phylo.to.map(mitoc_ultra, mitoc_coord,type="direct", ylim=c(18,50), xlim=c(38, 130), plot=TRUE, direction="downwards", asp=2)
```


**Part 4: Discussion**

We have only the figure that represents the mitochondrial sequences, but it is interesting nontheless. We can see in this figure that the phylogenetic tree resembles most observed relationship geographically. We can see these relationships as an example if we look at the southwest of the map, the *Phrynocephalus arabicus* and the *Phrynocephalus sp. JRM−2014a* are extremely close biologically and geographically. *Phrynocephalus luteoguttatus*, *Phrynocephalus ornatus*  and *Phrynocephalus clakurom* are all in the same clade and can also be found at a very close geographical distance in the middle-west of the map.

A very interesting finding though is the far localization between *Phrynocephalus guttatus* found in northeast and *Phrynocephalus guttatus salenskyi* in the far north, although they share a single node, they are very far away geographically. That might be explained by the movement of tectonic plates in the extreme past that might led to the diversification of these species (Macey et al., 2018).

**Part 5: Acknowledgement**

My work and all my coding experience wouldn’t be possible without my first professor, Dr. Yasser Morsy, who has been very supportive of teaching me all his experience in coding and deducing information from data. I would also like to thank my colleagues for guiding me through the design of my ideas and the formulation of my mental process, I especially like to thank Nishita, Gibran, Thomas, Jesse, Segun and Amjad for giving me ideas and helping me practise my coding skills. and at the end, I am very happy to be a part of a program that has an amazing teaching assistant Jessica Castellanos and I am very thankful for her remarks on my first assignment as it tremendously helped me on this one, and Professor Dirk Steinke for helping me with any questions I have about the bold database and tips about R.

**Part 6: References**

Macey, J. R., Schulte, J. A. I., Ananjeva, N. B., Dyke, E. T. V., Wang, Y., Orlov, N., Shafiei, S., Robinson, M. D., Dujsebayeva, T., Freund, G. S., Fischer, C. M., Liu, D., & Papenfuss, T. J. (2018). A molecular phylogenetic hypothesis for the Asian agamid lizard genus Phrynocephalus reveals discrete biogeographic clades implicated by plate tectonics. Zootaxa, 4467(1), 1-81. https://doi.org/10.11646/zootaxa.4467.1.1 

